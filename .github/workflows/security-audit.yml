name: Security Audit

on:
  # Run on pull requests to catch issues before merge
  pull_request:
    branches: [main]

  # Run weekly on Mondays at 9am UTC
  schedule:
    - cron: '0 9 * * 1'

  # Allow manual triggering from Actions tab
  workflow_dispatch:

jobs:
  security-audit:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: '.python-version'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run pip-audit on production dependencies
        id: prod-audit
        run: |
          echo "## Production Dependencies Security Audit" >> $GITHUB_STEP_SUMMARY
          pip-audit -r requirements.txt --desc --format=markdown >> $GITHUB_STEP_SUMMARY 2>&1 || echo "::warning::Vulnerabilities found in production dependencies"
        continue-on-error: true

      - name: Run pip-audit on dev dependencies
        id: dev-audit
        run: |
          echo "## Development Dependencies Security Audit" >> $GITHUB_STEP_SUMMARY
          pip-audit -r requirements-dev.txt --desc --format=markdown >> $GITHUB_STEP_SUMMARY 2>&1 || echo "::warning::Vulnerabilities found in dev dependencies"
        continue-on-error: true

      - name: Check if production vulnerabilities found
        if: steps.prod-audit.outcome == 'failure'
        run: |
          echo "::error::Security vulnerabilities found in production dependencies. Please review and update."
          exit 1
